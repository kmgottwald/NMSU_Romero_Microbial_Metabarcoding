### DADA2: Filter and trim ITS reads ###

# https://benjjneb.github.io/dada2/ITS_workflow.html
# following ITS specific DADA2 pipeline
# does not include truncLen=c(F,R)
# instead of setting fixed truncation length, set a min read length
# accounts for increased variability of ITS length compared to 16S
# already cut primers with cutadapt

# First, make the Rscript:
nano dada2_ITS_trim.R

# Copy the following text in:

# Load DADA2 package:
library(dada2)

# Define base path to fastq files
path <- "/fs1/scratch/kmg02/Sequencing_Data/ITS/primercut_ITS"

# Define paths to forward and reverse read folders
R1_path <- file.path(path, "Forward_R1")
R2_path <- file.path(path, "Reverse_R2")

# List forward and reverse reads
fnFs_fungi <- list.files(R1_path, pattern="_R1_trimmed.fastq.gz", full.names = TRUE)
fnRs_fungi <- list.files(R2_path, pattern="_R2_trimmed.fastq.gz", full.names = TRUE)


# Function to extract sample ID (everything before _R1_ or _R2_)
getSampleID <- function(f) sub("_R[12]_trimmed.fastq.gz$", "", basename(f))

sampleIDs_F <- sapply(fnFs_fungi, getSampleID)
sampleIDs_R <- sapply(fnRs_fungi, getSampleID)

# Find common samples in both forward and reverse
common_samples <- intersect(sampleIDs_F, sampleIDs_R)

# Subset and order forward files
fnFs_fungi <- fnFs_fungi[sampleIDs_F %in% common_samples]
sampleIDs_F <- sampleIDs_F[sampleIDs_F %in% common_samples]
ord_F <- order(sampleIDs_F)
fnFs_fungi <- fnFs_fungi[ord_F]
sampleIDs_F <- sampleIDs_F[ord_F]

# Subset and order reverse files
fnRs_fungi <- fnRs_fungi[sampleIDs_R %in% common_samples]
sampleIDs_R <- sampleIDs_R[sampleIDs_R %in% common_samples]
ord_R <- order(sampleIDs_R)
fnRs_fungi <- fnRs_fungi[ord_R]
sampleIDs_R <- sampleIDs_R[ord_R]

# Check that both vectors are the same length and order
stopifnot(length(fnFs_fungi) == length(fnRs_fungi))
stopifnot(all(sampleIDs_F == sampleIDs_R))

# Use the sample IDs as sample.names
sample.names <- sampleIDs_F

# Create output filtered file paths using sample.names
filtFs_fungi <- file.path(path, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs_fungi <- file.path(path, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))

# Name the output vectors
names(filtFs_fungi) <- sample.names
names(filtRs_fungi) <- sample.names

# Now run filterAndTrim with perfectly matched inputs and outputs
# set minLen to 50 instead of fixed truncation length
out_fungi <- filterAndTrim(fnFs_fungi, filtFs_fungi,
                         fnRs_fungi, filtRs_fungi,
                         maxN=0, maxEE=c(2,2), truncQ=2, minLen=50, rm.phix=TRUE,
                         compress=TRUE, multithread=4)

head(out_fungi)
write.csv(out_fungi, "filtered_output_summary.csv")

# end R-script

# Create slurm script:
nano dada2_ITS_trimjob.slurm

#!/bin/bash
#SBATCH --job-name=dada2_ITS_trimjob
#SBATCH --output=logs/dada2_ITS_trim_output.log
#SBATCH --error=logs/dada2_ITS_trim_error.log
#SBATCH --ntasks=1
#SBATCH --time=4:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --partition=normal

# Load personal conda
module load sstack/main
module use /fs1/home/kmg02/sstack/rhel_8/modules
module load conda/myconda

# Activate R environment and run Rscript
conda activate r_env_compatible 
Rscript /fs1/scratch/kmg02/Sequencing_Data/DADA2/Rscripts/dada2_ITS_trim.R

sbatch dada2_ITS_trimjob.slurm
squeue -j 376487
# running

