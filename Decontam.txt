### Run Decontam ###
# Remove contaminants from ASV tables
# Run 16s and ITS separately
# 16s first:

# Read in ASV table saved as rds file
ASV_16s <- readRDS("C:/Downloads/MS_Research/Sequencing/Bacteria/seqtab_16s.rds")

# Check number of ASV's
dim(ASV_16s)
# over 52,000 ASV
# Need to run decontam in HPC as a slurm job, too many ASVs to run directly in R

# make R script
nano decontam_16s.R

library(phyloseq)
library(decontam)

# Load Phyloseq object with metadata
phylo_raw <- readRDS("/fs1/scratch/kmg02/Sequencing_Data/clean_ASV/phyloseq_16s.rds")

# Add column for decontam to use:
sample_data(phylo_raw)$is.neg <- sample_data(phylo_raw)$Sample_or_Control == "control"

# check read counts per sample:
sample_sums(phylo_raw)

contamdf.prev05 <- isContaminant(phylo_raw, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05$contaminant)
# will show how many contaminants are present

# remove contaminants
phylo_decontam <- prune_taxa(!contamdf.prev05$contaminant, phylo_raw)
phylo_decontam #after

# Remove any samples with zero reads
phylo_clean <- prune_samples(sample_sums(phylo_decontam) > 0, phylo_decontam)
phylo_clean #check

# save as RDS for later use
saveRDS(phylo_clean, file = "/fs1/scratch/kmg02/Sequencing_Data/clean_ASV/ps_16s_clean.rds")

print("End of R script")

# Create slurm script:
nano decontam_16s.slurm

#!/bin/bash
#SBATCH --job-name=decontam_16s
#SBATCH --output=/fs1/scratch/kmg02/Sequencing_Data/logs/decontam_16s_output.log
#SBATCH --error=/fs1/scratch/kmg02/Sequencing_Data/logs/decontam_16s_error.log
#SBATCH --ntasks=1
#SBATCH --time=4:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --partition=normal
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=kmg02@nmsu.edu

# Load personal conda
module load sstack/main
module use /fs1/home/kmg02/sstack/rhel_8/modules
module load conda/myconda

# Activate R environment and run Rscript
conda activate r_env_compatible 
Rscript /fs1/scratch/kmg02/Sequencing_Data/clean_ASV/decontam_16s.R

sbatch decontam_16s.slurm
squeue -j 400603
# success, 69 contaminants were found and removed





# ITS:
# Read in ASV table saved as rds file
ASV_ITS <- readRDS("C:/Downloads/MS_Research/Sequencing/Fungi/seqtab_ITS.rds")
dim(ASV_ITS)
# 4,253 ASV's, can run this directly in R

# Clean contaminants with decontam:

# Load Phyloseq object with metadata

library(phyloseq)
library(decontam)

phylo_raw <- readRDS("C:/Downloads/MS_Research/Sequencing/Fungi/phyloseq_ITS.rds")

# Add column for decontam to use:
sample_data(phylo_raw)$is.neg <- sample_data(phylo_raw)$Sample_or_Control == "control"

# check read counts per sample:
sample_sums(phylo_raw)
# 92 ITS has zero total counts, will get removed

# Check contaminants
# "Threshold = the probability cutoff for classifying something as a contaminant," (Chatgpt)
# 0.5 threshold will identify sequences more prevalent in controls than samples, i.e. contaminants
contamdf.prev05 <- isContaminant(phylo_raw, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05$contaminant)
# 5 contaminants identified
# Need to manually filter out contaminants next

# Actually remove contaminants
phylo_decontam <- prune_taxa(!contamdf.prev05$contaminant, phylo_raw)
phylo_decontam #after

# Remove sample 92, had zero ASV reads
phylo_clean <- prune_samples(sample_sums(phylo_decontam) > 0, phylo_decontam)
phylo_clean #check

# save as RDS for later use
saveRDS(phylo_clean, file = "C:/Downloads/MS_Research/Sequencing/Fungi/ps_clean")

# still need to determine read threshold and rarefy